#!/usr/bin/env groovy

/*
 * Copyright (C) 2026 - present Instructure, Inc.
 *
 * This file is part of Canvas.
 *
 * Canvas is free software: you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License as published by the Free
 * Software Foundation, version 3 of the License.
 *
 * Canvas is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Affero General Public License along
 * with this program. If not, see <http://www.gnu.org/licenses/>.
 */

library "canvas-builds-library@${env.CANVAS_BUILDS_REFSPEC}"
loadLocalLibrary('local-lib', 'build/new-jenkins/library')

env.BUILD_REGISTRY_FQDN = configuration.buildRegistryFQDN()
env.COMPOSE_FILE = 'docker-compose.new-jenkins.yml'
env.POSTGRES_PASSWORD = 'sekret'

node(nodeLabel()) {
  timeout(time: 15, unit: 'MINUTES') {
    ansiColor('xterm') {
      timestamps {
        withCredentials([usernamePassword(credentialsId: 'PACT_BROKER', usernameVariable: 'PACT_BROKER_USERNAME', passwordVariable: 'PACT_BROKER_PASSWORD')]) {
          try {
            def stages = [:]

            def consumerEnvVars = [
              'DATABASE_CLEANER_ALLOW_REMOTE_DATABASE_URL=true',
              'DISABLE_SPRING=true',
              'ENCRYPTION_KEY=facdd3a131ddd8988b14f6e4e01039c93cfa0160',
              "PACT_BROKER=${env.PACT_BROKER_USERNAME}:${env.PACT_BROKER_PASSWORD}",
              'PACT_BROKER_HOST=inst-pact-broker.inseng.net',
              "PACT_BROKER_USERNAME=${env.PACT_BROKER_USERNAME}",
              "PACT_BROKER_PASSWORD=${env.PACT_BROKER_PASSWORD}",
              'PACT_BROKER_PROTOCOL=https',
              "POSTGRES_PASSWORD=${env.POSTGRES_PASSWORD}",
              "JENKINS_HOME=${env.JENKINS_HOME}",
              'RAILS_ENV=test',
              'RANDOMIZE_SEQUENCES=1',
            ]

          // Android test runs on the main coordinator node
          stages['Android'] = {
            contractTestsStage.runContractTest(
              'Android',
              'pact_test1',
              'android',
              consumerEnvVars,
              'cd /usr/src/app && bundle exec rake pact:verify',
              false
            )
          }

          // Canvas iOS and Sistemic each allocate their own nodes
          stages['Canvas iOS'] = {
            contractTestsStage.runContractTest(
              'Canvas iOS',
              'pact_test2',
              'canvas-ios',
              consumerEnvVars,
              'cd /usr/src/app && bundle exec rake pact:verify'
            )
          }

          stages['Sistemic'] = {
            contractTestsStage.runContractTest(
              'Sistemic',
              'pact_test3',
              'Sistemic',
              consumerEnvVars,
              'cd /usr/src/app && bundle exec rake pact:verify'
            )
          }

          parallel(stages)
          } finally {
            buildSummaryReport.saveRunManifest()
          }
        }
      }
    }
  }
}
