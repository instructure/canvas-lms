<% 
  dialog ||= false 
  jammit_css :full_assignment
  jammit_js :full_assignment 
  js_block { %><%= javascript_include_tag "tinymce/jscripts/tiny_mce/tiny_mce.js" %><% }
  assignment = full_assignment
  assignment_exists = assignment && (assignment.id || assignment.new_record?) rescue false 
  if !assignment_exists
    assignment = @context.assignments.new
  end
  is_discussion_topic = !!(assignment && assignment.submission_types == "discussion_topic" && assignment.discussion_topic)
%>
<% js_block do %>
<script type="text/javascript">
  var editIfNoContent = <%= (assignment_exists && assignment.submission_types != "online_quiz" && !can_do(assignment, @current_user, :read_own_submission)) ? "true" : "false" %>;
</script>
<% end %>

<div id="edit_letter_grades_form" style="display: none;">
  <%= render :partial => "shared/grading_standard", :object => (assignment.grading_standard rescue nil) %>
  <a href="<%= context_url(@context, :context_grading_standards_url) %>" style="display: none;" class="create_grading_standard_url">&nbsp;</a>
  <a href="<%= context_url(@context, :context_grading_standard_url, "{{ id }}") %>" style="display: none;" id="update_grading_standard_url">&nbsp;</a>
</div>
<div id="full_assignment_holder" class="<%= 'editing' if @editing %>" style="clear: right;">
  <% if params[:return_to] %>
    <a href="<%= clean_return_to(params[:return_to]) %>" class="redirect_on_finish_url" style="display: none;"></a>
  <% end %>
  <div class="assignment content_underline_links" id="full_assignment" style="<%= assignment && (assignment.id || assignment.new_record?) ? "" : "display: none;" %>">
    <% if (dialog) %>
      <a href="#" class="edit_full_assignment_link edit">Edit Assignment Details</a>
    <% end %>
    <div style="float: right; text-align: right; font-size: 0.8em;">
      <div class="date_text" style="<%= assignment_exists && assignment.due_at ? '' : 'display: none;' %>">
        due 
        <span class="due_date"><%= date_string(assignment.due_at) rescue "" %></span>
        by 
        <span class="due_time"><%= time_string(assignment.due_at) rescue "" %></span>
      </div>

      <div class="points_text" style="<%= assignment_exists && assignment.points_possible ? '' : 'display: none;' %>">
        out of <span class="points_possible"><%= assignment.points_possible rescue "" %></span>
      </div>
    </div>
    <h2 class="title">
      <%= assignment.title rescue "" %>
    </h2>
    <% if @locked %>
      <%= @locked.is_a?(Hash) ? lock_explanation(@locked, 'assignment', @context) : "This assignment is currently locked." %>
    <% end %>
    <% if @assignment && @assignment.context_module_tag && @assignment.context_module_tag.context_module %>
      <%= render :partial => "shared/context_module_legend", :object => @assignment.context_module_tag.context_module %>
    <% end %>
    <div class="quiz_content reminder" style="text-align: center; <%= "display: none;" unless assignment && assignment.submission_types == "online_quiz" && assignment.quiz %>">
      <div class="body">
        Grades for this assignment come from the quiz: <span class="quiz_title"><%= assignment.submission_types == 'online_quiz' && assignment.quiz.title rescue nbsp %></span>.<br/>
        <a class="assignment_quiz_link" href="<%= context_url(@context, :context_quiz_url, ((assignment && assignment.submission_types == 'online_quiz' && assignment.quiz) ? assignment.quiz.id : "{{ quiz_id }}")) %>" style="font-weight: bold;">Click here to go to the quiz</a>
        <a class="assignment_quiz_url" href="<%= context_url(@context, :context_quiz_url, "{{ quiz_id }}") %>" style="display: none;">&nbsp;</a>
      </div>
    </div>
    <div class="discussion_topic_content reminder-content" style="<%= hidden unless is_discussion_topic %>">
      <div class="body">
        This assignment is linked to the discussion, <span class="discussion_topic_title"><%= is_discussion_topic && assignment.discussion_topic.title rescue nbsp %></span>. Grading will be based on posts in the topic.<br/>
        <a class="assignment_topic_link content-link" href="<%= context_url(@context, :context_discussion_topic_url, (is_discussion_topic ? assignment.discussion_topic.id : "{{ discussion_topic_id }}")) %>" style="font-weight: bold;">Click here to go to the discussion</a>
        <a class="assignment_topic_url" href="<%= context_url(@context, :context_discussion_topic_url, "{{ discussion_topic_id }}") %>" style="display: none;">&nbsp;</a>
      </div>
    </div>
    <div class="clear"></div>
    
    <div class="description user_content"><%= assignment && assignment.description && !assignment.description.empty? ? user_content(assignment.description) : 'No Content' %></div>
    <div class="course_id" style="display: none;"><%= @context.id if @context && @context.is_a?(Course) %></div>

    <div style="display: none;">
      <span class="timestamp"><%= assignment.due_at.to_i rescue "" %></span>
      <span class="due_date_string"><%= assignment.due_at.strftime("%m/%d/%Y") rescue "" %></span>
      <span class="due_time_string"><%= assignment.due_at.strftime("%I:%M%p").downcase rescue "" %></span>
      <span class="group_id"><%= (assignment_exists && !assignment.group_name.empty? ? assignment.group_name : "other") rescue "other" %></span>
    </div>
  </div>
  <% if can_do(assignment, @current_user, :update_content) %>
  <% url = assignment && !assignment.new_record? ? context_url(@context, :context_assignment_url, assignment.id) : context_url(@context, :context_assignments_url) %>
  <% form_for assignment, :url => url, :html => {:method => (assignment && !assignment.new_record? ? 'PUT' : 'POST'), :id => 'edit_assignment_form', :style => 'display: none;'} do |f| %>
  <% show_more_grading_options = (assignment.min_score || assignment.max_score || assignment.mastery_score || !assignment.droppable?) rescue false %>
  <table class="formtable full_assignment_table" style="width: 100%;">
    <tr>
      <td colspan="4">
        <a href="#" style="font-size: 0.8em; float: right;" class="switch_full_assignment_view">Switch Views</a>
        <div class="assignment_content not_graded_content">
          Assignment Description:
        </div>
        <div class="quiz_content" style="display: none;">
          Quiz Summary/Introduction:
        </div>
        <div class="clear"></div>
        <div><%= f.text_area :description, :style => 'width: 100%;' %></div>
      </td>
    </tr>
    <% if can_do(assignment, @current_user, :update) %>
    <tr>
      <td style="width: 10%;">
        <div style="margin-bottom: 10px; <%= hidden if is_discussion_topic %>">Type:</div>
      </td><td style="width: 40%;">
          <select class="assignment_type" name="assignment_type" style="<%= hidden if is_discussion_topic %>">
            <option value="assignment" <%= "selected" if (assignment.submission_types != 'online_quiz' && assignment.submission_types != 'attendance' && assignment.submission_types != 'not_graded' rescue true) %>>Assignment</option>
            <option value="discussion_topic" <%= "selected" if (assignment.submission_types == 'discussion_topic' rescue false) %>>Discussion</option>
            <option value="quiz" <%= "selected" if (assignment.submission_types == 'online_quiz' rescue false) %>>Quiz</option>
            <% if feature_enabled?(:attendance) %>
              <option value="attendance" <%= "selected" if (assignment.submission_types == 'attendance' rescue false) %>>Attendance</option>
            <% end %>
            <option value="not_graded" <%= "selected" if (assignment.submission_types == 'not_graded' rescue false) %>>Not Graded</option>
          </select>
      </td>
      <td colspan="2" style="width: 50%;">
        <a href="#" class="more_options_link">more options</a>
      </td>
    </tr>
    <tr class="not_graded_content">
      <td colspan="4" style="font-size: 0.8em; padding-left: 10px; padding-top: 0; font-style: italic;">This assignment will not appear in the gradebook</td>
    </tr>
    <tr class="discussion_topic_content">
      <td colspan="4" style="font-size: 0.8em; padding-left: 10px; padding-top: 0; font-style: italic;">Grading for this assignment will be based on posts in the discussion</td>
    </tr>
    <tr class="quiz_content">
      <td colspan="4" style="font-size: 0.8em; padding-left: 10px; padding-top: 0; font-style: italic;">Grades for this assignment will be pulled from the quiz results</td>
    </tr>
    <tr>
      <td style="width: 10%;"><%= f.label :title, "Title:" %></td>
      <td style="width: 40%;"><%= f.text_field :title, :style => "width: 140px;" %></td>
      <td style="width: 25%;" class="more_assignment_values"><%= f.label :assignment_group_id, "Assignment Group:" %></td>
      <td style="width: 25%;" class="more_assignment_values">
        <%= f.select :assignment_group_id, (@assignment_groups.map {|g| [g.name, g.id]} << ["[ New Group ]", "new"]), :class => "#{(@context.weight_assignment_groups rescue false) ? 'weight' : ''}" %>
      </td>
    </tr><tr class="assignment_content">
      <td style="width: 10%;"><%= f.label :points_possible, "Points:", :style => "width: 50px;" %></td>
      <td style="width: 40%;">
        <!-- javascript check on change, if score is 0 then show text, "No score.  Any points set in the gradebook will be extra credit for this assignment's type" -->
        <%= f.text_field :points_possible, :style => "width: 140px;", :class => "points_possible" %>
      </td>
      <td style="width: 25%;" class="nobr more_assignment_values">
        <%= f.label :grading_type, "Grading By:" %>
        <!--span style="padding-left: 15px; font-size: 0.8em;">Graded As</span-->
      </td><td style="width: 25%;" class="more_assignment_values">
        <%= f.select :grading_type, {"Points" => "points", "Letter Grade" => "letter_grade", "Percentage" => "percent", "Complete/Incomplete" => "pass_fail" }, {:selected => (assignment.grading_type || "points")}, {:class => "grading_type"} %>
      </td>
    </tr><tr class="edit_letter_grades_link assignment_content" style="<%= "display: none;" if assignment.grading_type != "letter_grade" %>">
      <td style="width: 10%;" class="more_assignment_values"></td>
      <td style="width: 40%;" class="more_assignment_values"></td>
      <td style="width: 50%;" class="more_assignment_values" colspan="2" style="text-align: left; padding-top: 0;">
        <a href="#" style="padding-left: 10px; font-size: 0.8em;<%= "display: none;" if assignment.grading_type != "letter_grade" %>" class="edit_letter_grades_link">View Grading Levels</a>
      </td>
    </tr><tr class="more_grading_options" style="<%= show_more_grading_options ? "" : "display: none;" %>">
      <td style="width: 10%;" class="more_assignment_values"></td>
      <td style="width: 40%;" class="more_assignment_values"></td>
      <td style="width: 25%;" class="more_assignment_values">Score Range:</td>
      <td style="width: 25%;" class="more_assignment_values" title="Lowest and highest possible scores for this assignment">
        <%= f.text_field :min_score, :style => "width: 50px;", :class => "range_low" %>
        to
        <%= f.text_field :max_score, :style => "width: 50px;", :class => "range_high" %>
      </td>
    </tr><tr class="more_grading_options" style="<%= show_more_grading_options ? "" : "display: none;" %>">
      <td style="width: 10%;" class="more_assignment_values"></td>
      <td style="width: 40%;" class="more_assignment_values"></td>
      <td style="width: 25%;" class="more_assignment_values">Mastery Level:</td>
      <td style="width: 25%;" class="more_assignment_values">
        <%= f.text_field :mastery_score, :style => "width: 50px;", :class => "mastery_level" %>
        pts or higher
      </td>
    </tr><tr class="more_grading_options" style="<%= show_more_grading_options ? "" : "display: none;" %>">
      <td style="width: 10%;" class="more_assignment_values"></td>
      <td style="width: 40%;" class="more_assignment_values"></td>
      <td style="width: 50%;" class="more_assignment_values" colspan="2" style="text-align: right; display: none;">
        <input type="checkbox" name="never_drop" id="assignment_never_drop" <%= (assignment.droppable? rescue true) ? "" : "checked" %>/>
        <label for="assignment_never_drop">Never drop this assignment</label>
      </td>
    </tr><tr style="display: none;">
      <td class="more_assignment_values" colspan="4" style="text-align: right; padding: 0; display: none;">
        <a href="#" style="padding-right: 10px; font-size: 0.8em;" class="more_grading_options_link">more grading options</a>
      </td>
    </tr><tr>
    <!-- Accept multiple submissions?  Take the best, first, last, etc? Does that even make sense? -->
      <td style="width: 10%; vertical-align: top;">Due:</td>
      <td style="width: 40%; vertical-align: top;">
        <%= f.text_field :due_at, :value => datetime_string(assignment.due_at, :due_date), :style => "width: 120px;", :class => "date_field" %>
      </td>
      <td style="width: 50%;" class="more_assignment_values assignment_content" colspan="2">
        <input type="checkbox" name="group_assignment" id="assignment_group_assignment" <%= 'checked' if @assignment && @assignment.group_category %>/>
        <label for="assignment_group_assignment">This is a Group Assignment</label>
        <div id="assignment_group_category" style="<%= hidden unless @assignment && @assignment.group_category %>; margin-left: 20px;">
          <label for="assignment_group_category_select">Group Set:</label>
          <select id="assignment_group_category_select" name="assignment[group_category]">
            <option value="">[ Select Group Set ]</option>
            <% @context.groups.active.select{|g| g.category && g.category != Group.student_organized_category }.map{|g| g.category }.uniq.each do |category| %>
              <option value="<%= category %>" <%= 'selected' if @assignment && category == @assignment.group_category %>><%= category %></option>
            <% end %>
            <option value="new">[ New Group Set ]</option>
          </select><br/>
          <%= f.check_box :grade_group_students_individually %>
          <%= f.label :grade_group_students_individually, raw("Assign grades to each student individually<br/><span style='font-size: 0.8em;'>(normally all students receive the same grade on group assignments)</span>") %>
        </div>
      </td>
    </tr><tr>
      <td style="width: 10%; vertical-align: top;" class="more_assignment_values">Locked Until:</td>
      <td style="width: 40%; vertical-align: top;" class="more_assignment_values">
        <%= f.text_field :unlock_at, :value => datetime_string(assignment.unlock_at), :style => "width: 120px;", :class => "date_field" %>
      </td>
      <td style="width: 50%;" class="more_assignment_values assignment_content" colspan="2">
        <%= f.check_box :peer_reviews, :id => 'assignment_peer_reviews' %>
        <label for="assignment_peer_reviews">Require Peer Reviews</label>
        <table id="assignment_peer_reviews_options" style="margin-left: 10px; <%= hidden unless @assignment && @assignment.has_peer_reviews? %>">
          <tr>
            <td colspan="2">
              <div>
                <input type="radio" name="assignment[automatic_peer_reviews]" value="0" id="manual_peer_reviews" <%= 'checked' if !@assignment || !@assignment.automatic_peer_reviews %> />
                <label for="manual_peer_reviews">Manually Assign Peer Reviews</label>
              </div>
              <div>
                <input type="radio" name="assignment[automatic_peer_reviews]" value="1" id="auto_peer_reviews" <%= 'checked' if @assignment && @assignment.automatic_peer_reviews %> />
                <label for="auto_peer_reviews">Automatically Assign Peer Reviews</label>
              </div>
            </td>
          </tr>
          <tr class="auto_peer_reviews">
            <td><%= f.label :peer_review_count, "Reviews Per User:" %></td>
            <td><%= f.text_field :peer_review_count, :style => "width: 20px;" %></td>
          </tr><tr class="auto_peer_reviews">
            <td style="vertical-align: top;"><%= f.label :peer_reviews_assign_at, "Assign Reviews:", :style => "float: left;" %></td>
            <td>
              <div>
                <%= f.text_field :peer_reviews_assign_at, :value => datetime_string(assignment.peer_reviews_assign_at, :due_date), :style => "width: 120px;", :class => "date_field" %>
              </div>
              <div style="font-size: 0.8em;">Must come after due date. If blank, uses due date.</div>
            </td>
          </tr>
        </table>
      </td>
    </tr><tr class="submission_content">
      <td style="width: 10%; vertical-align: top;">Submission:</td>
      <td style="vertical-align: top;" colspan="1">
        <select name="submission_type" class="submission_type_option">
          <option value="none" <%= "selected" if (!assignment.submission_types || assignment.submission_types == "none") %>>No Submission</option>
          <option value="online" <%= "selected" if (assignment.submission_types && (assignment.submission_types.match(/media/) || assignment.submission_types.match(/online/))) %>>Online Submission</option>
          <option value="on_paper" <%= "selected" if (assignment.submission_types == "on_paper") %>>On Paper</option>
        </select>
      </td>
      <td style="width: 10%; vertical-align: top;" class="more_assignment_values">Lock Submits After:</td>
      <td style="width: 40%; vertical-align: top;" class="more_assignment_values">
        <%= f.text_field :lock_at, :value => datetime_string(assignment.lock_at), :style => "width: 120px;", :class => "date_field" %>
      </td>
    </tr><tr class="submission_content">
      <td colspan="2">
        <div style="padding: 0px 30px;<%= "display: none;" if (!assignment.submission_types || !assignment.submission_types.match("online")) %>" class="online_submission_types">
          <div><input type="checkbox" name="online_upload" <%= "checked" if (assignment.submission_types && assignment.submission_types.match("online_upload")) %> id="assignment_online_upload"/><label for="assignment_online_upload"> Allow File Uploads</label></div>
          <div><input type="checkbox" name="online_text_entry" <%= "checked" if (assignment.submission_types && assignment.submission_types.match("online_text_entry")) %> id="assignment_online_text_entry"/><label for="assignment_online_text_entry"> Allow Text Entry</label></div>
          <div><input type="checkbox" name="online_url" <%= "checked" if (assignment.submission_types && assignment.submission_types.match("online_url")) %> id="assignment_online_url"/><label for="assignment_online_url"> Allow Website URL</label></div>
          <% if feature_enabled?(:kaltura) %>
            <div><input type="checkbox" name="media_recording" <%= "checked" if (assignment.submission_types && assignment.submission_types.match("media_recording")) %> id="assignment_media_recording"/><label for="assignment_media_recording"> Allow Media Recordings</label></div>
          <% end %>
          <% if @context.turnitin_enabled? %>
            <div style="margin-top: 10px;">
              <%= f.check_box :turnitin_enabled %>
              <%= f.label :turnitin_enabled, "Enable Turnitin Submission Evaluations" %>
            </div>
          <% end %>
        </div>
      </td>
      <td style="width: 50%;" class="more_assignment_values assignment_content" colspan="2">
        <div id='restrict_file_extensions_options'>
          <input type="checkbox" name="restrict_file_extensions" id="assignment_restrict_file_extensions" <%= 'checked' if @assignment && @assignment.allowed_extensions.present? %>/>
          <label for="assignment_restrict_file_extensions">Restrict the Permitted File Upload Extensions</label>
          <div id='allowed_extensions_options' style="margin-left: 20px;">
            <label for="assignment_allowed_extensions">Allowed File Extensions:</label>
              <br>
              <%= f.text_field :allowed_extensions, :value => (assignment.allowed_extensions || []).join(",") %>
              <br>
              <span style='font-size: 0.8em;'>enter a list of accepted extensions, for example: doc,xls,txt</span>
          </div>
        </div>
      </td>
    </tr>
    <% end %>
    <tr>
      <td colspan="4">
        <%= f.check_box :notify_of_update %>
        <%= f.label :notify_of_update, "Notify users that this content has changed" %>
      </td>
    </tr>
    <tr>
      <td colspan="4">
        <button type="submit" class="button">Update Assignment</button>
        <button type="button" class="button-secondary cancel_button">Cancel</button>
      </td>
    </tr>
  </table>
  <% end %>
  <% end %>
</div>

<%= render :partial => "shared/add_assignment_group" %>
<%= render :partial => "groups/add_group_category" %>

