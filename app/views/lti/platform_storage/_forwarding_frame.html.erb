<%
# Copyright (C) 2022 - present Instructure, Inc.
#
# This file is part of Canvas.
#
# Canvas is free software: you can redistribute it and/or modify it under
# the terms of the GNU Affero General Public License as published by the Free
# Software Foundation, version 3 of the License.
#
# Canvas is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
# details.
#
# You should have received a copy of the GNU Affero General Public License along
# with this program. If not, see <http://www.gnu.org/licenses/>.
%>

<%
  # Don't render the forwarder frame _inside_ the forwarder frame
  # or on any login pages/when not logged in
  if action_name != "post_message_forwarding" && !request.path.starts_with?("/login")
    current_domain = request.host_with_port
    oidc_auth_domain = Lti::Oidc.auth_domain(current_domain)
 %>
  <%=
    iframe(
      lti_post_message_forwarding_url(
        host: oidc_auth_domain,
        token: Lti::PlatformStorageController.parent_domain_jwt(current_domain),
        rev: Lti::PlatformStorageController.rev_fingerprint
      ),
      name: Lti::PlatformStorage::FORWARDING_TARGET,
      title: Lti::PlatformStorage::FORWARDING_TARGET,
      id: Lti::PlatformStorage::FORWARDING_TARGET,
      sandbox: "allow-scripts allow-same-origin",
      style: "display:none;"
    )
  %>
<% end %>
